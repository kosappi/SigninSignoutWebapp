# README

Rails 5.1.1 のデフォルト状態に、手作りでユーザ認証システム(登録、編集、ログイン、ログアウト)を追加したものです。

## 動作環境

* Ruby 2.4.1
* Bundler 1.15.1

## 起動まで

まずは clone してください。

```
$ git clone git@github.com:kosappi/SigninSignoutWebapp.git
```

次に、bundle install してください。

```
$ cd ./SigninSignoutWebapp
$ bundle install --path vendor/bundler
```

起動の前に、マイグレーションを実行してください。

```
$ bundle exec rake db:migrate
```

最後に、rails コマンドでウェブサーバを起動してください。

```
$ bundle exec rails server
```

## 画面説明

ルートパスにアクセスすると新規登録画面が出ます。

![1](http://i.imgur.com/MDdJ7WY.png?1)

新規登録画面とログイン画面は相互に移動できます。

![2](http://i.imgur.com/LMeEmRq.png?1)

新規登録を完了すると個人情報画面に飛びます。

![3](http://i.imgur.com/QKjQgzc.png?1)

自分の情報を編集できます。

![4](http://i.imgur.com/YKFu9uk.png?1)

ログインした状態でルートパスにアクセスした場合、新規登録フォームは出ません。
また、ログイン画面から　ログインした場合は、こちらの画面に飛びます。

![5](http://i.imgur.com/icOeImG.png?1)

## 認証機構

今回作成した認証機構について説明します。

* 暗号化には SHA-256 を使用 (Rubyのライブラリを利用)
* DBには暗号化した情報のみ置くようにしています
* ユーザの下記のカラムを暗号化しています
    * パスワード
        * 新規登録時、編集時に更新されます
    * ログイントークン
        * ログイン時に作成され、ログアウト時に破棄されます
        * 暗号化されてないものを cookie で保持します


* SHA-256 を選んだ理由
    * 暗号として強力だから
    * Ruby に標準搭載されていて, すぐに使えるから
* cookie に平文トークン, DB に暗号済みトークンを置く理由
    * 万が一, DB に侵入された場合でも平文トークンの復元が難しいから
* パスワードを暗号化してDBに置く理由
    * 万が一, DB に侵入された場合でも平文パスワードの復元が難しいから

認証の流れは下記のようになっています。

#### ログイン時

1. DBから、メールアドレスを持つユーザを探す
1. 該当するユーザの暗号済みパスワードと、リクエストのパスワードを暗号化したものを、比較する
1. 一致した場合は、新しいログイントークン発行し、cookieに保存する
1. ログイントークンを暗号化したものを、DBに保存する

#### ログアウト時

1. ログイン中のユーザの暗号済みログイントークンを、DBから削除する
1. cookieのログイントークンを削除する

#### ログイン中かどうかの判断

1. DBから、暗号済みログイントークンを持つユーザを探す
1. 該当するユーザがいる場合、該当ユーザでログイン中と判断する

#### 新規登録時

1. フォームの入力内容から、ユーザを新しくDBに登録する
1. その際、パスワードは暗号化してDBに保存する
1. 上記が完了したら、ログイントークンを発行する(ログイン時と同じ)

## これから

#### 追加したい機能

* パスワード再発行機能
    * よくある、メールに再設定URLを貼ってあるやつ
* メール承認機能
    * 登録承認メールを送って,ユーザを承認する
* アカウントのロック機能
    * ログイン試行回数に制限をもうける
    * 制限を突破した場合はアカウントをロックする
* バックオフィス機能
    * 管理者の認証機構
    * 既存ユーザの管理機能
* 自動テスト
    * Rspec による自動テストを想定
* API整備
    * ユーザ情報のAPIを整備して, ajax に対応する
    * 他のサービスでもユーザ情報にアクセスできるようにする

#### 改善したいところ

* フロントエンド
    * スマホでも見られるように(PCでしかテストしていません...)
* SQLの発行数を減らす
    * ログイントークンに毎回アクセスする必要があるので
    * キャッシュ機能(Redis, memechachedなど)を利用したい
    * おそらく, 高速にさばけるようになるはず
